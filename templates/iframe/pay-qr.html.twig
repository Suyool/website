<style>
    .logo{
        margin:20px auto 20px auto;
    }

    .subtitle{
        font-size: 18px;
    }
    #qr-code{
        margin: 20px 0;
    }
    #qr-code img{
        max-width: 100%;
        width: 235px;
        display: none;
    }
    .IframeCont h5 {
        margin: 0;
        margin-bottom: 9px;
        color: #465567;
        font-family: 'Helvetica Neue, Bold';
        font-size: 20px;
    }
    .stepsImageCont img {
        max-width: 45%;
    }
    .message{
        color: #216D96;
    }
    .displayBlock {
        display: inline-block!important;
    }
    .icon-image-cont {
        border: 1px solid #216D96;
        width: 220px;
        margin: auto;
        padding: 45px;
        border-radius: 15px;
        margin-bottom: 40px;
    }
    .icon-image {
        display: none;
        margin: 10px 0;
    }
    .info {
        margin-top: 20px;
        margin-left: 20px;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
</style>
<div class="pay">
{#    <div class="info">#}
{#        <p><b>OrderId:</b> {{ order_id }}</p>#}
{#        <p><b>Amount:</b> {{ Amount }}</p>#}
{#        <p><b>Currency:</b> {{ Currency }}</p>#}
{#    </div>#}
    <div class="pay-qr" style="text-align: center">
        <div class="icon-image-cont">
            <img class="icon-image" src="" alt="" >
            <p class="message" id="text-message">{{ ReturnText }}</p>
        </div>
        <div class="QR-cont">
            <div class="logo">
                <img src="http://dev.suyool.com/build/images/suyool-Logo.png">
            </div>
            <div class="subtitle">
                Scan this QR to complete the tranasction
            </div>
            <div id="qr-code">
                <img class={{ displayBlock }} src={{ pictureURL }}>
            </div>
        </div>
        <div class="IframeCont" align="center">
            <h5>HOW TO PAY?</h5>
            <div class="stepsImageCont">
                <img src="{{ asset('build/images/scan-qr-steps.png') }}"/>
            </div>
        </div>
        <div>
            <input type="hidden" id="transaction_id" value="{{ order_id }}">
            <input type="hidden" id="merchant_id" value="{{ merchantId }}">
            <input type="hidden" id="callBack_URL" value="{{ CallBackURL }}">
            <input type="hidden" id="env" value="{{ env }}">

        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>
    var pollingInterval; // Variable to hold the polling interval ID

    $(document).ready(function() {
        // Initial call to checkPaymentStatus
        checkPaymentStatus();
    });

    function checkPaymentStatus() {
        var merchant_id = $("#merchant_id").val();
        var transaction_id = $("#transaction_id").val();
        var callbackUrl = $("#callBack_URL").val();
        var env = $("#env").val();

        if (merchant_id != '' && transaction_id != '') {
            $.ajax({
                type: 'POST',
                url: "{{ main_url }}{{ path('app_Iframe_check_status') }}",
                data: {
                    merchant_id: merchant_id,
                    transaction_id: transaction_id,
                    callBack_URL: callbackUrl,
                    env: env,
                },
                success: function(data) {
                    var paymentInfo = data;

                    if (paymentInfo['Flag'] === 2 || paymentInfo['Flag'] === 4) {
                        // Continue polling if the status is 2 or 4
                        pollingInterval = setTimeout(function() {
                            checkPaymentStatus();
                        }, 3000);
                    } else {
                        // Stop polling and handle the result
                        clearInterval(pollingInterval); // Stop the polling interval

                        // Inform the user with the payment status
                        $('#text-message').html(paymentInfo['ReturnText']);
                        $('.QR-cont').hide();
                        if (paymentInfo['Flag'] === 1) {
                            $('.icon-image-cont').css({'color': '#1ED66C', 'border': '1px solid #1ED66C'});
                            $('.icon-image-cont .message').css({'color': '#1ED66C'});

                        } else {
                            $('.icon-image-cont').css({'color': '#F0021A', 'border': '1px solid #F0021A'});
                            $('.icon-image-cont .message').css({'color': '#F0021A'});

                        }
                        if (callbackUrl === "") {
                            if(paymentInfo['Flag'] === 1) {
                                $('.icon-image').attr('src', '{{ asset('build/images/approved.png') }}');
                            } else {
                                $('.icon-image').attr('src', '{{ asset('build/images/decline.png') }}');
                            }
                            $('.icon-image').show();

                        }else {
                            setTimeout(function () {
                                if (window.opener) {
                                    window.opener.location.href = paymentInfo['CallBackURL'];
                                    window.self.close();
                                } else {
                                    window.top.location.href = paymentInfo['CallBackURL'];
                                }
                            }, 3000);
                        }
                    }
                },
            });
        }
    }
</script>
